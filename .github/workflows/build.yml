name: Build
run-name: ${{ github.actor }} - ${{ github.workflow }} - ${{ github.ref_name }}
on: 
  push:
    branches: 
    - main
  pull_request:
    branches: 
    - main
  workflow_dispatch:


jobs:
    Build:
        runs-on: ubuntu-24.04
        continue-on-error: true
        outputs:
            new_tag: ${{ steps.set_tag_output.outputs.new_tag }}
        steps:
        -   uses: actions/checkout@v6
            name: Clone self
        -   uses: actions/checkout@v6
            name: Clone chebfun
            with:
                path: ${{ github.workspace }}/chebfun
                repository: chebfun/chebfun
                fetch-depth: '0'
        -   run: git config --global --add safe.directory ${{ github.workspace }}/chebfun
            name: Allow git operations in chebfun
        -   name: Bump version and push tag
            if: github.ref_name == 'main'
            id: tag_version
            uses: anothrNick/github-tag-action@v1
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # if you don't want to set write permissions use a PAT token
                TAG_PREFIX: v
                RELEASE_BRANCHES: main
                SOURCE: chebfun
                DRY_RUN: true
                INITIAL_VERSION: 1.0.0
                VERBOSE: true
        -   name: Set Tag Output
            if: github.ref_name == 'main'
            id: set_tag_output
            run: echo "::set-output name=new_tag::${{ steps.tag_version.outputs.new_tag }}"
        -   name: Set up MATLAB
            uses: matlab-actions/setup-matlab@v2
        -   name: Package toolbox
            uses: matlab-actions/run-command@v2
            with:
                command: addpath('${{ github.workspace }}'); package("chebfun","${{ github.workspace }}/chebfun", "${{ github.workspace }}","${{ steps.tag_version.outputs.new_tag }}");
        -   uses: actions/upload-artifact@v4
            name: Upload chebfun.mltbx
            with:
                name: chebfun.mltbx
                path: ${{ github.workspace }}/chebfun.mltbx
    Release:
        needs: Build
        runs-on: ubuntu-latest
        if: github.ref_name == 'main'
        steps:
        -   uses: actions/download-artifact@v4
            name: Download chebfun.mltbx
            with:
                path: ${{ github.workspace }}
        -   name: Create Release
            id: create_release
            uses: actions/create-release@latest
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                tag_name: ${{ needs.Build.outputs.new_tag }}
                release_name: Release ${{ needs.Build.outputs.new_tag }}
                draft: false
                prerelease: false
        -   name: Release
            uses: softprops/action-gh-release@v2
            with:
                files: ${{ github.workspace }}/chebfun.mltbx
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


